<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>micro.rkt</title>
<meta name="generator" content="emacs 25.1.1; htmlfontify 0.21" />
<style type="text/css"><!-- 
body { font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #eeeeee;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.default   { font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #eeeeee;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.default a { font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #eeeeee;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.comment-delimiter   { color: #5f9ea0;  font-style: italic;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.comment-delimiter a { color: #5f9ea0;  font-style: italic;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.racket-selfeval-face   { color: #2e8b57;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.racket-selfeval-face a { color: #2e8b57;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.function-name   { color: #daa520;  font-weight: 700;  font-family: Courier New;  font-stretch: normal;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.function-name a { color: #daa520;  font-weight: 700;  font-family: Courier New;  font-stretch: normal;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.builtin   { color: #f08080;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.builtin a { color: #f08080;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.racket-paren-face   { color: #696969;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.racket-paren-face a { color: #696969;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.comment   { color: #5f9ea0;  font-style: italic;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.comment a { color: #5f9ea0;  font-style: italic;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.variable-name   { color: #4eee94;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.variable-name a { color: #4eee94;  font-family: Courier New;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
span.keyword   { color: #00bfff;  font-weight: 700;  font-family: Courier New;  font-stretch: normal;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: none; }
span.keyword a { color: #00bfff;  font-weight: 700;  font-family: Courier New;  font-stretch: normal;  font-style: normal;  background: #102e4e;  font-size: 10pt;  text-decoration: underline; }
 --></style>

    <script type="text/javascript"><!--
  // this function is needed to work around
  // a bug in IE related to element attributes
  function hasClass(obj)
  {
      var result = false;
      if (obj.getAttributeNode("class") != null)
      {
          result = obj.getAttributeNode("class").value;
      }
      return result;
  }

  function stripe(id)
  {
      // the flag we'll use to keep track of
      // whether the current row is odd or even
      var even = false;

      // if arguments are provided to specify the colors
      // of the even & odd rows, then use the them;
      // otherwise use the following defaults:
      var evenColor = arguments[1] ? arguments[1] : "#fff";
      var oddColor  = arguments[2] ? arguments[2] : "#ddd";

      // obtain a reference to the desired table
      // if no such table exists, abort
      var table = document.getElementById(id);
      if (! table) { return; }

      // by definition, tables can have more than one tbody
      // element, so we'll have to get the list of child
      // &lt;tbody&gt;s
      var tbodies = table.getElementsByTagName("tbody");

      // and iterate through them...
      for (var h = 0; h < tbodies.length; h++)
      {
          // find all the &lt;tr&gt; elements...
          var trs = tbodies[h].getElementsByTagName("tr");

          // ... and iterate through them
          for (var i = 0; i < trs.length; i++)
          {
              // avoid rows that have a class attribute
              // or backgroundColor style
              if (! hasClass(trs[i]) &&
                  ! trs[i].style.backgroundColor)
              {
                  // get all the cells in this row...
                  var tds = trs[i].getElementsByTagName("td");

                  // and iterate through them...
                  for (var j = 0; j < tds.length; j++)
                  {
                      var mytd = tds[j];

                      // avoid cells that have a class attribute
                      // or backgroundColor style
                      if (! hasClass(mytd) &&
                          ! mytd.style.backgroundColor)
                      {
                          mytd.style.backgroundColor =
                            even ? evenColor : oddColor;
                      }
                  }
              }
              // flip from odd to even, or vice-versa
              even =  ! even;
          }
      }
  }

  function toggle_invis( name )
  {
      var filter =
        { acceptNode:
          function( node )
          { var classname = node.id;
            if( classname )
            { var classbase = classname.substr( 0, name.length );
              if( classbase == name ) { return NodeFilter.FILTER_ACCEPT; } }
            return NodeFilter.FILTER_SKIP; } };
      var walker = document.createTreeWalker( document.body           ,
                                              NodeFilter.SHOW_ELEMENT ,
                                              filter                  ,
                                              false                   );
      while( walker.nextNode() )
      {
          var e = walker.currentNode;
          if( e.style.display == "none" ) { e.style.display = "inline"; }
          else                            { e.style.display = "none";   }
      }
  }
--> </script>
  </head>
  <body onload="stripe('index'); return true;">

<pre><span class="keyword">#lang</span> <span class="variable-name">racket</span>

<span class="comment">#|
</span><span class="comment">GroundTerm ::       Bool </span><span class="comment">| Sym | () |</span><span class="comment"> Cons t u
</span><span class="comment">Var ∋ x :: Nat
</span><span class="comment">|#</span> 

<span class="comment">#| var? : Term -&gt; Bool |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="variable-name">var?</span> <span class="builtin">number?</span><span class="racket-paren-face">)</span>

<span class="comment">#| var : Nat -&gt; Var |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">var</span> n<span class="racket-paren-face">)</span> n<span class="racket-paren-face">)</span> 

<span class="comment">#|
</span><span class="comment">Term ∋ t,u :: Var </span><span class="comment">| Bool | Sym | () |</span><span class="comment"> Cons t u
</span><span class="comment">
</span><span class="comment">Solve equations over these terms. 
</span><span class="comment">|#</span>GG

<span class="racket-selfeval-face">'3</span>
'<span class="racket-paren-face">(</span>cat <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">))</span>

'<span class="racket-paren-face">(</span><span class="racket-selfeval-face">2</span> <span class="racket-selfeval-face">3</span> <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span>
'<span class="racket-paren-face">(</span>cat <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">))</span>

<span class="comment">#|
</span><span class="comment">Not just decide if solvable, but produce a solution.
</span><span class="comment">
</span><span class="comment">Subst ∋ s :: () | Cons (Var × Term) Subst
</span><span class="comment">
</span><span class="comment">Similar and different from an environment.
</span><span class="comment">|#</span>

<span class="racket-selfeval-face">'3</span>
'<span class="racket-paren-face">(</span>cat <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">))</span>
'<span class="racket-paren-face">(</span><span class="racket-selfeval-face">3</span> . <span class="racket-paren-face">(</span>cat <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">)))</span>

'<span class="racket-paren-face">(</span><span class="racket-selfeval-face">2</span> <span class="racket-selfeval-face">3</span> <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span>
'<span class="racket-paren-face">(</span>cat <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">))</span>
'<span class="racket-paren-face">((</span><span class="racket-selfeval-face">1</span> . <span class="racket-paren-face">(</span>horse <span class="racket-selfeval-face">2</span><span class="racket-paren-face">))</span> <span class="racket-paren-face">(</span><span class="racket-selfeval-face">3</span> . <span class="racket-paren-face">(</span>fish <span class="racket-selfeval-face">1</span><span class="racket-paren-face">))</span> <span class="racket-paren-face">(</span><span class="racket-selfeval-face">2</span> . cat<span class="racket-paren-face">))</span>

<span class="comment">#|
</span><span class="comment">Again, these should be /solutions/ to equations. 
</span><span class="comment">So additional restrictions:
</span><span class="comment">
1. No var is the LHS or RHS if it already appears as an LHS
   '((0 . cat) (0 . dog))
   '((0 . 1) (1 . 2))
|#</span>

<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">walk</span> t s<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">pr</span> <span class="racket-paren-face">(</span><span class="keyword">and</span> <span class="racket-paren-face">(</span>var? t<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">assv</span> t s<span class="racket-paren-face">))))</span>
    <span class="racket-paren-face">(</span><span class="keyword">if</span> pr <span class="racket-paren-face">(</span>walk <span class="racket-paren-face">(</span><span class="builtin">cdr</span> pr<span class="racket-paren-face">)</span> s<span class="racket-paren-face">)</span> t<span class="racket-paren-face">)))</span>

<span class="comment">#|
2. No /association/ creates a cycle.
   '((0 . (0)))
   '((0 . (1)) (1 . (0)))
|#</span>

<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">occurs?</span> x v s<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">v</span> <span class="racket-paren-face">(</span>walk v s<span class="racket-paren-face">)))</span>
    <span class="racket-paren-face">(</span><span class="keyword">cond</span>
      <span class="racket-paren-face">((</span>var? v<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">eqv?</span> x v<span class="racket-paren-face">))</span>
      <span class="racket-paren-face">((</span><span class="builtin">pair?</span> v<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="keyword">or</span> <span class="racket-paren-face">(</span>occurs? x <span class="racket-paren-face">(</span><span class="builtin">car</span> v<span class="racket-paren-face">)</span> s<span class="racket-paren-face">)</span>
                     <span class="racket-paren-face">(</span>occurs? x <span class="racket-paren-face">(</span><span class="builtin">cdr</span> v<span class="racket-paren-face">)</span> s<span class="racket-paren-face">)))</span>
      <span class="racket-paren-face">(</span><span class="keyword">else</span> <span class="racket-selfeval-face">#f</span><span class="racket-paren-face">))))</span>

<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">ext-s</span> x v s<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">cond</span>
    <span class="racket-paren-face">((</span>occurs? x v s<span class="racket-paren-face">)</span> <span class="racket-selfeval-face">#f</span><span class="racket-paren-face">)</span> 
    <span class="racket-paren-face">(</span><span class="keyword">else</span> `<span class="racket-paren-face">((</span>,x . ,v<span class="racket-paren-face">)</span> . ,s<span class="racket-paren-face">))))</span>

<span class="comment">#|

There is often more than one solution to an equation. How do we
choose? What sort of solution do we want?  We want it to be no more
specific than necessary — a /most general/ one. 
|#</span>

<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">unify</span> t u s<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">t</span> <span class="racket-paren-face">(</span>walk t s<span class="racket-paren-face">))</span> <span class="racket-paren-face">(</span><span class="variable-name">u</span> <span class="racket-paren-face">(</span>walk u s<span class="racket-paren-face">)))</span>
    <span class="racket-paren-face">(</span><span class="keyword">cond</span>
      <span class="racket-paren-face">((</span><span class="builtin">eqv?</span> t u<span class="racket-paren-face">)</span> s<span class="racket-paren-face">)</span> <span class="comment-delimiter">;; </span><span class="comment">both same variable
</span>      <span class="racket-paren-face">((</span>var? t<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>ext-s t u s<span class="racket-paren-face">))</span> <span class="comment-delimiter">;; </span><span class="comment">add association 
</span>      <span class="racket-paren-face">((</span>var? u<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>ext-s u t s<span class="racket-paren-face">))</span> <span class="comment-delimiter">;; </span><span class="comment">add association 
</span>      <span class="racket-paren-face">((</span><span class="keyword">and</span> <span class="racket-paren-face">(</span><span class="builtin">pair?</span> t<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">pair?</span> u<span class="racket-paren-face">))</span> <span class="comment-delimiter">;; </span><span class="comment">recur
</span>       <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">s</span> <span class="racket-paren-face">(</span>unify <span class="racket-paren-face">(</span><span class="builtin">car</span> t<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">car</span> u<span class="racket-paren-face">)</span> s<span class="racket-paren-face">)))</span>
         <span class="racket-paren-face">(</span><span class="keyword">and</span> s <span class="racket-paren-face">(</span>unify <span class="racket-paren-face">(</span><span class="builtin">cdr</span> t<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">cdr</span> u<span class="racket-paren-face">)</span> s<span class="racket-paren-face">))))</span>
      <span class="racket-paren-face">(</span><span class="keyword">else</span> <span class="racket-selfeval-face">#f</span><span class="racket-paren-face">))))</span> <span class="comment-delimiter">;; </span><span class="comment">&quot;clash&quot; – fail
</span>
<span class="comment">#|
We can solve an equation, and produce solutions. 
Ta da!
|#</span>

<span class="racket-paren-face">(</span>unify <span class="racket-selfeval-face">'2</span> <span class="racket-selfeval-face">'cat</span> '<span class="racket-paren-face">())</span>

<span class="comment">#| And we can almost solve /incrementally/! |#</span>
<span class="racket-paren-face">(</span>unify '<span class="racket-paren-face">(</span><span class="racket-selfeval-face">2</span> . <span class="racket-selfeval-face">0</span><span class="racket-paren-face">)</span> '<span class="racket-paren-face">(</span>cat . <span class="racket-selfeval-face">2</span><span class="racket-paren-face">)</span> '<span class="racket-paren-face">())</span>
<span class="racket-paren-face">(</span>unify <span class="racket-selfeval-face">'0</span> <span class="racket-selfeval-face">'2</span> <span class="racket-paren-face">(</span>unify <span class="racket-selfeval-face">'2</span> <span class="racket-selfeval-face">'cat</span> '<span class="racket-paren-face">()))</span>

<span class="comment-delimiter">;; </span><span class="comment">But! (unify '0 '2 (unify 'dog 'cat '()))
</span>
<span class="comment">#|
Moreover:  
1. Passing store explicitly.
2. No (lexical) scope for variables.
3. Doesn't allow multiple answers.
4. Doesn't allow incremental solving/failure. 
|#</span>

<span class="comment">#|
1. State is explicit
– Add plumbing
|#</span>

<span class="comment">#| 
Goal :: Subst -&gt; List Subst

 == : Term Term -&gt; Goal |#</span>
<span class="comment-delimiter">;; </span><span class="comment">tentative
</span><span class="comment-delimiter">;; </span><span class="comment">(define ((== t u) s)
</span><span class="comment-delimiter">;;   </span><span class="comment">(let ((s (unify t u s)))
</span><span class="comment-delimiter">;;     </span><span class="comment">(if s (list s) '())))
</span>
<span class="comment">#| call/empty-s : Goal -&gt; List Subst |#</span>
<span class="comment-delimiter">;; </span><span class="comment">tentative
</span><span class="comment-delimiter">;; </span><span class="comment">(define (call/empty-s g)
</span><span class="comment-delimiter">;;   </span><span class="comment">(g '()))
</span>
<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s (== '0 'cat))
</span>
<span class="comment">#|
2. No (lexical) scope for variables.
– Use Racket's scope. 
|#</span>

<span class="comment-delimiter">;;   </span><span class="comment">(λ (x) (== x 'cat))
</span>
<span class="comment-delimiter">;; </span><span class="comment">(((λ (x) (== x 'cat)) 0) '())
</span>
<span class="comment-delimiter">;; </span><span class="comment">Which number to pass? Multiple variables?
</span>
<span class="comment">#|
State ∋ s/c     :: Subst × Count
Count ∋ c       :: Nat
Goal  ∋ g,g₁,g₂ :: State -&gt; List State
|#</span>

<span class="comment">#| call/empty-s : Goal -&gt; List State |#</span>
<span class="comment-delimiter">;; </span><span class="comment">tentative
</span><span class="comment-delimiter">;; </span><span class="comment">(define (call/empty-s g)
</span><span class="comment-delimiter">;;   </span><span class="comment">(g '(() . 0)))
</span>
<span class="comment">#| == : Term Term -&gt; Goal |#</span>
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">((</span><span class="function-name">==</span> t u<span class="racket-paren-face">)</span> s/c<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">s</span> <span class="racket-paren-face">(</span>unify t u <span class="racket-paren-face">(</span><span class="builtin">car</span> s/c<span class="racket-paren-face">))))</span>
    <span class="racket-paren-face">(</span><span class="keyword">if</span> s <span class="racket-paren-face">(</span><span class="builtin">list</span> `<span class="racket-paren-face">(</span>,s . ,<span class="racket-paren-face">(</span><span class="builtin">cdr</span> s/c<span class="racket-paren-face">)))</span> '<span class="racket-paren-face">())))</span>

<span class="comment">#| (Var -&gt; Goal) -&gt; Goal |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">((</span><span class="function-name">call/fresh</span> f<span class="racket-paren-face">)</span> s/c<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">c</span> <span class="racket-paren-face">(</span><span class="builtin">cdr</span> s/c<span class="racket-paren-face">)))</span>
    <span class="racket-paren-face">(</span><span class="keyword">let</span> <span class="racket-paren-face">((</span><span class="variable-name">g</span> <span class="racket-paren-face">(</span>f <span class="racket-paren-face">(</span>var c<span class="racket-paren-face">))))</span>
      <span class="racket-paren-face">(</span>g `<span class="racket-paren-face">(</span>,<span class="racket-paren-face">(</span><span class="builtin">car</span> s/c<span class="racket-paren-face">)</span> . ,<span class="racket-paren-face">(</span><span class="builtin">add1</span> c<span class="racket-paren-face">))))))</span>

<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(call/fresh 
</span><span class="comment-delimiter">;;         </span><span class="comment">(λ (y)
</span><span class="comment-delimiter">;;           </span><span class="comment">(== `(,y . ,x) `(cat . ,y)))))))
</span>
<span class="comment">#|
3. Doesn't allow multiple answers.
– must have disjunction.
|#</span>

<span class="comment">#| Goal Goal -&gt; Goal |#</span> 
<span class="comment-delimiter">;; </span><span class="comment">(define ((disj g₁ g₂) s/c) (___ (g₁ s/c) (g₂ s/c)))
</span>
<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(disj 
</span><span class="comment-delimiter">;;         </span><span class="comment">(== x 'cat)
</span><span class="comment-delimiter">;;         </span><span class="comment">(== x 'dog)))))
</span>
<span class="comment">#| List State List State -&gt; List State |#</span> 
<span class="comment-delimiter">;; </span><span class="comment">tentative 
</span><span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">___</span> $₁ $₂<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">cond</span>
    <span class="racket-paren-face">((</span><span class="builtin">null?</span> $₁<span class="racket-paren-face">)</span> $₂<span class="racket-paren-face">)</span>
    <span class="racket-paren-face">(</span><span class="keyword">else</span> <span class="racket-paren-face">(</span><span class="builtin">cons</span> <span class="racket-paren-face">(</span><span class="builtin">car</span> $₁<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>___ <span class="racket-paren-face">(</span><span class="builtin">cdr</span> $₁<span class="racket-paren-face">)</span> $₂<span class="racket-paren-face">)))))</span>

<span class="comment">#|
4. Doesn't allow incremental solving/failure. 
– must have conjunction
|#</span>

<span class="comment">#| Goal Goal -&gt; Goal |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">((</span><span class="function-name">conj</span> g₁ g₂<span class="racket-paren-face">)</span> s/c<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>$append-map g₂ <span class="racket-paren-face">(</span>g₁ s/c<span class="racket-paren-face">)))</span>

<span class="comment">#| Goal List State -&gt; List State |#</span> 
<span class="comment-delimiter">;; </span><span class="comment">tentative 
</span><span class="comment-delimiter">;; </span><span class="comment">(define ($append-map g $)
</span><span class="comment-delimiter">;;   </span><span class="comment">(cond
</span><span class="comment-delimiter">;;     </span><span class="comment">((null? $) '())
</span><span class="comment-delimiter">;;     </span><span class="comment">(else (___ (g (car $)) ($append-map g (cdr $))))))
</span>
<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(conj 
</span><span class="comment-delimiter">;;         </span><span class="comment">(== x 'cat)
</span><span class="comment-delimiter">;;         </span><span class="comment">(== x 'dog)))))
</span>
<span class="comment-delimiter">;; </span><span class="comment">Properly shadows 
</span><span class="comment-delimiter">;; </span><span class="comment">(call/empty-s
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(conj 
</span><span class="comment-delimiter">;;        </span><span class="comment">(== x 'cat)
</span><span class="comment-delimiter">;;        </span><span class="comment">(call/fresh
</span><span class="comment-delimiter">;;          </span><span class="comment">(λ (x) 
</span><span class="comment-delimiter">;;            </span><span class="comment">(== x 'dog)))))))
</span>
<span class="comment">#|
5. Cannot program recursively
– add recursion (thoughtfully!)
|#</span>

<span class="comment-delimiter">;; </span><span class="comment">(define (turtles x)
</span><span class="comment-delimiter">;;   </span><span class="comment">(disj
</span><span class="comment-delimiter">;;     </span><span class="comment">(== x 'turtle)
</span><span class="comment-delimiter">;;     </span><span class="comment">(turtles x)))
</span>
<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s
</span><span class="comment-delimiter">;;   </span><span class="comment">(turtles 'turtle))
</span>
<span class="comment">#|
Stream ∋ $,$₁,$₂ :: State × Stream </span><span class="comment">| () |</span><span class="comment"> Delay Stream
Goal  ∋ g,g₁,g₂  :: State ↛ Stream
|#</span>

<span class="racket-paren-face">(</span><span class="keyword">define-syntax-rule</span> <span class="racket-paren-face">(</span><span class="function-name">define-relation</span> <span class="racket-paren-face">(</span>n . args<span class="racket-paren-face">)</span> g<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">((</span><span class="function-name">n</span> . args<span class="racket-paren-face">)</span> s/c<span class="racket-paren-face">)</span>
    <span class="racket-paren-face">(</span><span class="builtin">delay</span> <span class="racket-paren-face">(</span>g s/c<span class="racket-paren-face">))))</span>

<span class="racket-paren-face">(</span><span class="builtin">delay</span> <span class="racket-selfeval-face">5</span><span class="racket-paren-face">)</span>
<span class="racket-paren-face">(</span><span class="builtin">force</span> <span class="racket-paren-face">(</span><span class="builtin">delay</span> <span class="racket-selfeval-face">5</span><span class="racket-paren-face">))</span>

<span class="racket-paren-face">(</span>define-relation <span class="racket-paren-face">(</span><span class="function-name">empty</span> x<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="builtin">empty</span> x<span class="racket-paren-face">))</span>

<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s (empty 'cat))
#| 
MatureStream :: Cons State Stream | ()
|#</span>

<span class="comment">#| pull : Stream ↛ Mature Stream |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">pull</span> $<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">cond</span> 
    <span class="racket-paren-face">((</span><span class="builtin">promise?</span> $<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>pull <span class="racket-paren-face">(</span><span class="builtin">force</span> $<span class="racket-paren-face">)))</span>
    <span class="racket-paren-face">(</span><span class="keyword">else</span> $<span class="racket-paren-face">)))</span>

<span class="comment">#| call/empty-s : Goal ↛ Mature Stream |#</span>
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">call/empty-s</span> g<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span>pull <span class="racket-paren-face">(</span>g '<span class="racket-paren-face">(()</span> . <span class="racket-selfeval-face">0</span><span class="racket-paren-face">))))</span>

<span class="comment">#| Goal Stream -&gt; Stream |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">$append-map</span> g $<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">cond</span>
    <span class="racket-paren-face">((</span><span class="builtin">null?</span> $<span class="racket-paren-face">)</span> '<span class="racket-paren-face">())</span>
    <span class="racket-paren-face">((</span><span class="builtin">promise?</span> $<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">delay</span> <span class="racket-paren-face">(</span>$append-map g <span class="racket-paren-face">(</span><span class="builtin">force</span> $<span class="racket-paren-face">))))</span>
    <span class="racket-paren-face">(</span><span class="keyword">else</span> <span class="racket-paren-face">(</span>$append <span class="racket-paren-face">(</span>g <span class="racket-paren-face">(</span><span class="builtin">car</span> $<span class="racket-paren-face">))</span> <span class="racket-paren-face">(</span>$append-map g <span class="racket-paren-face">(</span><span class="builtin">cdr</span> $<span class="racket-paren-face">))))))</span>

<span class="comment">#| Stream Stream -&gt; Stream |#</span> 
<span class="comment-delimiter">;; </span><span class="comment">tentative
</span><span class="comment-delimiter">;; </span><span class="comment">(define ($append $₁ $₂)
</span><span class="comment-delimiter">;;   </span><span class="comment">(cond
</span><span class="comment-delimiter">;;     </span><span class="comment">((null? $₁) $₂)
</span><span class="comment-delimiter">;;     </span><span class="comment">((promise? $₁) (delay ($append (force $₁) $₂)))
</span><span class="comment-delimiter">;;     </span><span class="comment">(else (cons (car $₁) ($append (cdr $₁) $₂)))))
</span>
<span class="racket-paren-face">(</span>define-relation <span class="racket-paren-face">(</span><span class="function-name">turtles</span> x<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span>disj
    <span class="racket-paren-face">(</span><span class="builtin">==</span> x <span class="racket-selfeval-face">'turtle</span><span class="racket-paren-face">)</span>
    <span class="racket-paren-face">(</span>turtles x<span class="racket-paren-face">)))</span>

<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s 
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh 
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(disj (turtles x) (empty x)))))
</span>
<span class="comment">#| But we can't get! |#</span>

<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>call/fresh 
    <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>x<span class="racket-paren-face">)</span>
      <span class="racket-paren-face">(</span>disj <span class="racket-paren-face">(</span><span class="builtin">empty</span> x<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>cats x<span class="racket-paren-face">)))))</span>

<span class="comment">#| And even worse |#</span>

<span class="racket-paren-face">(</span>define-relation <span class="racket-paren-face">(</span><span class="function-name">cats</span> x<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span>disj
    <span class="racket-paren-face">(</span><span class="builtin">==</span> x <span class="racket-selfeval-face">'cat</span><span class="racket-paren-face">)</span>
    <span class="racket-paren-face">(</span>cats x<span class="racket-paren-face">)))</span>

<span class="comment-delimiter">;; </span><span class="comment">(call/empty-s 
</span><span class="comment-delimiter">;;   </span><span class="comment">(call/fresh 
</span><span class="comment-delimiter">;;     </span><span class="comment">(λ (x)
</span><span class="comment-delimiter">;;       </span><span class="comment">(disj (turtles x) (cats x)))))
</span>
<span class="comment">#| Stream Stream -&gt; Stream |#</span> 
<span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">(</span><span class="function-name">$append</span> $₁ $₂<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span><span class="keyword">cond</span>
    <span class="racket-paren-face">((</span><span class="builtin">null?</span> $₁<span class="racket-paren-face">)</span> $₂<span class="racket-paren-face">)</span>
    <span class="racket-paren-face">((</span><span class="builtin">promise?</span> $₁<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span><span class="builtin">delay</span> <span class="racket-paren-face">(</span>$append $₂ <span class="racket-paren-face">(</span><span class="builtin">force</span> $₁<span class="racket-paren-face">))))</span>
    <span class="racket-paren-face">(</span><span class="keyword">else</span> <span class="racket-paren-face">(</span><span class="builtin">cons</span> <span class="racket-paren-face">(</span><span class="builtin">car</span> $₁<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>$append <span class="racket-paren-face">(</span><span class="builtin">cdr</span> $₁<span class="racket-paren-face">)</span> $₂<span class="racket-paren-face">)))))</span>

<span class="comment-delimiter">;; </span><span class="comment">JUST HERE TO MAKE IT RUN
</span><span class="racket-paren-face">(</span><span class="keyword">define</span> <span class="racket-paren-face">((</span><span class="function-name">disj</span> g₁ g₂<span class="racket-paren-face">)</span> s/c<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>$append <span class="racket-paren-face">(</span>g₁ s/c<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>g₂ s/c<span class="racket-paren-face">)))</span>

<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>call/fresh 
    <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>x<span class="racket-paren-face">)</span>
      <span class="racket-paren-face">(</span>disj <span class="racket-paren-face">(</span><span class="builtin">empty</span> x<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>cats x<span class="racket-paren-face">)))))</span>

<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>call/fresh 
    <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>x<span class="racket-paren-face">)</span>
      <span class="racket-paren-face">(</span>disj <span class="racket-paren-face">(</span>turtles x<span class="racket-paren-face">)</span> <span class="racket-paren-face">(</span>cats x<span class="racket-paren-face">)))))</span>

<span class="racket-paren-face">(</span>define-relation <span class="racket-paren-face">(</span><span class="function-name">appendº</span> l t o<span class="racket-paren-face">)</span>
  <span class="racket-paren-face">(</span>disj
    <span class="racket-paren-face">(</span>conj <span class="racket-paren-face">(</span><span class="builtin">==</span> l '<span class="racket-paren-face">())</span> <span class="racket-paren-face">(</span><span class="builtin">==</span> t o<span class="racket-paren-face">))</span>
    <span class="racket-paren-face">(</span>call/fresh
      <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>a<span class="racket-paren-face">)</span> 
        <span class="racket-paren-face">(</span>call/fresh 
          <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>d<span class="racket-paren-face">)</span>
            <span class="racket-paren-face">(</span>conj
              <span class="racket-paren-face">(</span><span class="builtin">==</span> `<span class="racket-paren-face">(</span>,a . ,d<span class="racket-paren-face">)</span> l<span class="racket-paren-face">)</span>
              <span class="racket-paren-face">(</span>call/fresh 
                <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>res<span class="racket-paren-face">)</span>
                  <span class="racket-paren-face">(</span>conj
                    <span class="racket-paren-face">(</span><span class="builtin">==</span> `<span class="racket-paren-face">(</span>,a . ,res<span class="racket-paren-face">)</span> o<span class="racket-paren-face">)</span>
                    <span class="racket-paren-face">(</span>appendº d t res<span class="racket-paren-face">)))))))))))</span>


<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>appendº '<span class="racket-paren-face">(</span>a b c<span class="racket-paren-face">)</span> '<span class="racket-paren-face">(</span>d e<span class="racket-paren-face">)</span> '<span class="racket-paren-face">(</span>a b c d e<span class="racket-paren-face">)))</span>

<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>call/fresh
    <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>o<span class="racket-paren-face">)</span>
      <span class="racket-paren-face">(</span>appendº '<span class="racket-paren-face">(</span>a b c<span class="racket-paren-face">)</span> '<span class="racket-paren-face">(</span>d e<span class="racket-paren-face">)</span> o<span class="racket-paren-face">))))</span>

<span class="racket-paren-face">(</span>call/empty-s 
  <span class="racket-paren-face">(</span>call/fresh
    <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>l<span class="racket-paren-face">)</span>
      <span class="racket-paren-face">(</span>call/fresh
       <span class="racket-paren-face">(</span><span class="keyword">λ</span> <span class="racket-paren-face">(</span>t<span class="racket-paren-face">)</span>
         <span class="racket-paren-face">(</span>appendº l t '<span class="racket-paren-face">(</span>a b c d e<span class="racket-paren-face">)))))))</span>
</pre>

 </body>
</html>
